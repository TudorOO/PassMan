{%extends "index.html"%}
{% block title %}PassMan{% endblock %}
{% block content %} 

    <style>
        .loader {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        position: relative;
        animation: rotate 1s linear infinite
      }
      .loader::before , .loader::after {
        content: "";
        box-sizing: border-box;
        position: absolute;
        inset: 0px;
        border-radius: 50%;
        border: 5px solid #FFF;
        animation: prixClipFix 2s linear infinite ;
      }
      .loader::after{
        transform: rotate3d(90, 90, 0, 180deg );
        border-color: #198754;
      }

      @keyframes rotate {
        0%   {transform: rotate(0deg)}
        100%   {transform: rotate(360deg)}
      }

      @keyframes prixClipFix {
          0%   {clip-path:polygon(50% 50%,0 0,0 0,0 0,0 0,0 0)}
          50%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 0,100% 0,100% 0)}
          75%, 100%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,100% 100%,100% 100%)}
      }

    </style>

    <script type="text/javascript" src = "../static/js/cse.js"></script>
    <script>

        function closeDialog(dialogID){
            const dia = document.getElementById(dialogID);
            dia.remove();
        }

        function addHTML(html){
            const template = document.createElement("template");
            template.innerHTML = html.trim();

            return template.content.firstElementChild;
        }

        function showMasterModal(){
            const popup = addHTML(`
            <dialog id = "mpass_dia">
                <button onmouseover="this.style.color='white'" onmouseout="this.style.color=''" onclick = "closeDialog('mpass_dia')" type="button" class="btn-close" aria-label="Close"></button>
                <form method = 'POST' id = "search_form" hx-post = "/api/get_breach_number" hx-trigger="submit" hx-target = "#result" hx-swap="innerHTML">
                    <input type = "hidden" id = "user_id" value = "{{user.id}}">
                    <input type = "hidden" name = "csrf_token" id = "csrf_token" value = "{{csrf_token()}}"/>
                    <h3 class = "mt-2 mb-7 text-center">Master Password</h3>
                    <div class = "form-group text-center">
                        <input
                            type = "password"
                            class = "form-control border-bottom mb-4 text-center"
                            id = "maspass" name = "maspass"
                            placeholder = "Enter Master Password"
                        >
                    </div>
                    <div class="d-flex justify-content-center" id="lastFormElement">
                        <button class = "btn btn-primary position-relative" onmouseover="this.style.color='white'" onmouseout="this.style.color=''"
                            type = "submit" 
                            name = "submit_button" 
                            id = "submit_buttonForm"
                        value = "New Passkey">Search</button>
                        <span class = "loader" id = "loader" style="display: none;"></span>
                    </div>
                </form> 
            </dialog>`);
            document.body.appendChild(popup);
            const dia = document.getElementById("mpass_dia");
            dia.showModal();
        }

        document.body.addEventListener("submit", async function(event){
            if(event.target.id === "search_form"){

                event.preventDefault();

                //Get stuff
                const csrfToken = document.getElementById("csrf_token").value;
                const id = Number(document.getElementById("user_id").value);

                // Get form data(maspass)
                const form = event.target;
                const fd = new FormData(form);
                var data = Object.fromEntries(fd.entries());

                // Encrypt the password before sending
                var salt, iv;
                ivsalt = await get_salt_iv(EMAIL = undefined, ID = id,  TOKEN = csrfToken);
                salt = ivsalt.salt;
                iv = ivsalt.iv;

                const key = await generateKey(data.maspass, salt);
                var enc1 = await encrypt(data.maspass, key, iv=iv);
                const pack1 = pack(enc1.cypher);

                data.maspass = pack1;
                data.csrf_token = csrfToken;

                console.log("Sent encrypted mpass");

                document.getElementById("lastFormElement").removeChild(document.getElementById("submit_buttonForm"));
                document.getElementById("loader").style.display = "block";

                // Update htmx request
                await htmx.ajax("POST", "/api/get_breach_number", {
                    source: form,
                    target: '#result',
                    swap: "innerHTML",
                    values: {
                        maspass: data.maspass,
                        csrfToken: csrfToken
                    },
                });

                document.getElementById("loader").style.display = "none";

                closeDialog("mpass_dia");

            }
        });
        document.body.addEventListener("htmx:afterRequest", function(evt) {
            console.log("HTMX request complete");
            console.log("Response:", evt.detail.xhr.responseText);
        });
        document.body.addEventListener("htmx:responseError", function(evt) {
            Toastify({
                text: "HTMX error:" + evt.detail.xhr.status + "," + evt.detail.xhr.responseText || "An unknown error occurred.",
                duration: 3000,
                gravity: "bottom",
                position: "right",
                backgroundColor: "#f44336"
            }).showToast()
        });

    </script>


    <h2 class = "text-center mt-3">Dashboard</h2>

    <!--Vault stats-->

    <h3 class = "text-center mt-7 mb-7">Vault stats</h3>
    
    <div class="row text-center">
        <div class="col">
            <div class="card p-3">
                <h5>Total Passkeys</h5>
                <p class="display-6">{{ user.keys|length }}</p>
            </div>
        </div>
        <div class="col">
            <div class="card p-3">
                <h5>Encryption method</h5>
                <p style="font-size: 25px;">{{user.enc_method}}</p>
            </div>
        </div>
        <div class="col">
            <div class="card p-3">
                <h5>Two Factor Authentication</h5>
                {%if user.twofa%}
                    <p class="display-6" style = "color: green;">Enabled</p>
                {%else%}
                    <p class="display-6" style = "color: red;">Disabled</p>
                {%endif%}
            </div>
        </div>
    </div>

    <div class="row text-center">
        <div class="col">
            <div class="card p-3">
                <h5>Time since last password vault update</h5>
                <p class="display-6">{{ time_since_last_update }}</p>
            </div>
        </div>
        <div class="col">
            <div class="card p-3">
                <h5>Time since last master password change</h5>
                <p class="display-6">{{ time_since_last_mpass_change }}</p>
            </div>
        </div>
        <div class="col">
            <div class="card p-3">
                <h5>Last login location(not including this one)</h5>
                <p class="display-6">{{ user.last_login }}</p>
            </div>
        </div>
    </div>




    <!--Breach monitoring-->
    <div id = "breach_monitor">
        <h3 class =  "text-center mt-10 mb-2">Live breach monitoring</h3>
        <div id = "Search_Breaches" class="mb-4">
            <button type = "button" id = "ShowButton" class = "btn btn-primary mx-auto d-block" onclick = "showMasterModal()">Search for breaches</button> 
        </div>
    </div>

    <div id = "result">
        <table class = "table">
            <thead class = "thead-dark">
                <tr>
                    <th scope = "col">#</th>
                    <th scope = "col">App</th>
                    <th scope = "col">Number of breaches</th>
                    <th scope = "col">Last change</th>
                    <th scope = "col">Recommended action</th>
                </tr>
            </thead>
            <tbody>
                {%for key in user.keys%}

                    <tr>
                        <th scope = "row">{{key.id}}</th>
                        <td>{{key.app}}</td>
                        <td>{{key.breaches}}</td>
                        <td>{{key.lastUpdate.replace(microsecond=0)}}</td>
                        {% if key.breaches < 2%}
                            <td>Nothing :)</td>
                        {% else %}
                            <td>Reset immediatly!</td>
                        {% endif %}
                    </tr>

                {%endfor%}
            </tbody>
        </table>
    </div>
{%endblock%}